# Bazel Genrule Permissions

Bazel sets the permissions on
[genrule](https://bazel.build/reference/be/general#genrule)
outputs to be *read-only* and *executable*. There exists a `executable`
attribute which you can set to `False`, but it is
[ignored](https://github.com/bazelbuild/bazel/issues/3359), contrary to what the
Bazel docs [state](https://bazel.build/reference/be/general#genrule.executable).

For regular, non-executable files produced by genrules we would expect the
permissions to be set to:

```
-r--r--r--
```

We might also naively expect the file to be writable, as if we had created it
ourself on our own command line.

```
-rw-rw-rw-
```

However, what we get instead is:

```
-r-xr-xr-x
```

The solution is to change the permissions on the file generated by the genrule
in the targets that consume it, with something like `chmod 666 file.txt` or the
language-specific equivalent in a program consuming the file as data.

This repo shows a bare-minimum example of where this can cause problems if we
expect the output file from a genrule to be *writable*. Run it
with `bazel build :add_world` or `:add_world_fixed`.

```bazel
# Generate a file containing the word "Hello"
genrule(
    name = "gen_hello",
    cmd = "echo 'Hello' > $@",
    outs = ["hello.txt"],
)

# Copy the file generated by the other genrule to a temporary file called
# tmp.txt, which inherits the same permissions.
#
# Then attempt to modify the file by appending the word "World". This will fail
# because we cannot write to the file. And we cannot write to the file because
# the :gen_hello rule set it to read-only.
genrule(
    name = "add_world",
    srcs = [":hello.txt"],
    cmd = """
cp $(location hello.txt) tmp.txt

echo "\nCan't append, file has these permissions:"
ls -la tmp.txt

echo 'World' >> tmp.txt

cp tmp.txt $@
""",
    outs = ["hello_world.txt"],
)

# Fixes the broken genrule by making tmp.txt writable.
genrule(
    name = "add_world_fixed",
    srcs = [":hello.txt"],
    cmd = """
cp $(location hello.txt) tmp.txt

chmod 666 tmp.txt

echo 'World' >> tmp.txt
cp tmp.txt $@
""",
    outs = ["hello_world_fixed.txt"],
)
```
